Обзор общей конструкции и способы взаимодействия
================================================

**Аннотация**

Agrolab GH – автономный или отапливаемый парник для круглогодичного или внесезонного выращивания тепличных культур и рассады, представляющий собой сооружение защищенного грунта со светопроницаемым куполом. В Agrolab GH образуется постоянная атмосфера с, по возможности, настраиваемыми параметрами внутренней среды. На здоровье растений в значительной мере влияют многие факторы, как например: влажность воздуха, кислотность, влажность и солевой баланс почвы, содержание кислорода, диоксида углерода в атмосфере, интенсивность солнечного излучения и тп. Часто за этим всем приходится следить человеку, однако, большую часть работы может взять на себя автоматизированная система.

Для эффективного климат контроля такое сооружение необходимо снабдить датчиками, показания которых будут влиять на дальнейшее “поведение” Agrolab GH. 

Конструкция корпуса автоматической Agrolab GH
------------------------------------------

Agrolab GH представляет из себя прямоугольный короб 35*33*73см, выполненный из оргстекла (Рис.1). 
Ребра короба укреплены металлическими уголками, обеспечивая конструкции достаточную жёсткость.
На боковой длинной грани есть две прозрачные дверцы 22,5*27 см (Рис.2.), примыкающие к рёбрам, смежным с малыми гранями. Их назначение заключается в повышении удобства манипуляции внутренними объектами в случае вмешательства со стороны человека.


.. |pic1| image:: images/1.png
   :width: 45% 

.. |pic2| image:: images/4.png
   :width: 45%


|pic1| |pic2|

Рис.1. Разрабатываемая автоматическая Agrolab GH Рис.2. Боковые дверцы Agrolab GH

Вентиляция
~~~~~~~~~~

Механическую часть представляют два вентилятора (Рис.3), по одному на каждой из малых гранях. Они обеспечивают принудительный продув, а за контроль потока отвечают два сервопривода, контролирующие крышки на вентиляторах. 

.. figure:: images/2.png
       :width: 60%
       :align: center
       :alt: Вентилятор и сервопривод

       Рис.3. Вентилятор и сервопривод


Еще ``два сервопривода`` поднимают два квадратных горизонтальных прозрачных люка 24.5*27 см (Рис.4), находящихся сверху на крышке и примыкающих к ребрам, смежным с крышкой и малыми гранями. Передача движения осуществляется через незакрепленный на люке рычаг, что позволяет без риска повреждения конструкции открыть люк вручную в любой момент. Данный элемент конструкции даёт возможность осуществлять контролируемый естественный воздухообмен с внешней атмосферой.
Использование разных способов обновления воздуха внутри обеспечивает Agrolab GH универсальность и позволяет обеспечить эффективность конструкции при выращивании различных культур.

.. figure:: images/3.png
       :width: 60%
       :align: center
       :alt: Один из верхних люков с рычажной системой подъема сервоприводом

       Рис.4. Один из верхних люков с рычажной системой подъема сервоприводом


Полив
~~~~~

В представленной концепции используется четыре датчика внутри самой Agrolab GH ``света``, ``газа``, ``влажности воздуха`` и ``влажности почвы``. Пятый датчик – ``поплавок``, который находится в резервуаре с водой для полива отслеживает её уровень. Резервуар представляет из себя пластмассовую чёрную канистру на ``750мл``, прикрепленную снаружи Agrolab GH.

Светодиодная лента
~~~~~~~~~~~~~~~~~~

Светодиодная лента выполняет сигнализационную функцию для сообщения ответственному лицу о случившейся неполадке. 

Подробный обзор конструкции блока
---------------------------------

На данный момент мы переходим к тематике подробного описания блока. Блок – отдельная часть конструкции умной Agrolab GH, содержащая ``управляющие элементы``, ``информационную панель`` и ``датчик температуры``. 

Геометрические характеристики   
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Блок размещается над корпусом Agrolab GH, между дверцами. 
::
  Ширина: 180 мм
  Длина: 340 мм
  Высота: 155 мм
Блок выполнен из панелей матового оргстекла толщиной 5 мм с технологическими отверстиями, соединённых металлическими уголками. 

Микроконтроллер
~~~~~~~~~~~~~~~

 
На проекте «Agrolab_GH» используется плата ``ESP-JS-AR``.

Помимо возможности подключения различных периферийных модулей контроллер ESP-JS-AR обладает возможностью подключения и управления исполнительными механизмами – двигателями постоянного тока и сервоприводами. Для этого на его борту располагается 2 блока клемников для подключения классических двигателей постоянного тока. 

Так же предусмотрена возможность подключения как квадратурных (до 2х штук), так и инкрементных (до 4х штук) энкодеров. Кроме обычных двигателей постоянного тока контроллер может управлять двигателями по интерфейсу CAN. Из специфических интерфейсов контроллер обладает интерфейсами ``RS485`` и 3х пиновым полудуплексным UART, что позволяет подключать к контроллеру Dynamixel-совместимые модули – как сенсорные, так и сервоприводы. В зависимости от модификации используется либо 3х, либо 4х пиновые разъемы MOLEX или JST.

Для беспроводного обмена данными на контроллере имеются как классические интерфейсы – WiFi и Bluetooth, реализованные в центральном модуле контроллера – ESP32 WROVER’е, так и модули для приема и передачи данных в ИК-диапазоне на частоте в 38 Кгц Питание контроллера может быть осуществлено следующими способами: от 5В через miniUSB разъем. Однако в данном случае часть функционала контроллера будет недоступна (из за ограниченности отдачи тока по шине USB). Более того, в ряде случае контроллер от питания через USB вообще не будет функционировать. 

Поэтому совместно с подключением по USB рекомендуется использовать дополнительное внешнее питание - От Ethernet разъема, используя технологию POE. 

.. figure:: images/Таблица1.png
       :width: 60 %
       :align: center
       :alt: jsar


Расположение значимых элементов изображено на схеме 

.. figure:: images/13.png
       :width: 30 %
       :align: center
       :alt: jsar


Здесь:

1. ``ON-OFF_BUT`` - Кнопка включения\выключения контроллера

2. ``PWR_IN`` – Разъем для подключения внешнего силового питания

3. ``BAT`` – Клеменик для подключения внешнего силового питания. По своей сути аналогичен с разъемом PWR_IN. Внимание! При подключении питания соблюдайте полярность!

4. ``Индикаторы питания``. Красный – 5В, зеленый – 12В

5. ``USB`` – Порт типа miniUSB для программирования контроллера

6. ``ETHERNET`` – Разъем для подключения к проводной сети Ethernet. Поддерживает POE

7. ``IR_RX`` – Приемник сигнала в ИК диапазоне на частоте 38кГц

8. ``RS485`` – 4х пиновый разъем типа Molex для подключения совместимых периферийных устройств

9. ``HALH-DUPLEX UART`` – 3х пиновый разъем типа Molex для подключения совместимых периферийных устройств

10. ``RS485`` – 4х пиновый разъем типа JST для подключения совместимых периферийных устройств

11. ``HALH-DUPLEX UART`` – 3х пиновый разъем типа JST для подключения совместимых периферийных устройств

12. ``IR_TX`` – Передатчик сигнала в ИК диапазоне

13. ``RST_BUT`` – Кнопка перезагрузки контроллера

14. ``USR_BUT`` – Пользовательская программируемая кнопка

15. ``EXPANDER_LED`` – Программируемый индикационный светодиод расширителя портов ввода-вывода

16. ``ESP_LED`` – Программируемый индикационный светодиод модуля ESP32 WROVER

17. ``Аналог ISP интерфейса`` для совместимости контроллера с подключаемыми Arduino-шилдами. По факту содержит в себе интерфейс SPI, продублированный с боковых гребенок, 5В, GND и RST

18. ``PAS_POE`` – штыри для подключения джамперов в случае использования Passive POE. Джамперы устанавливаются по прямоугольникам, изображенным на плате. 

Блок №III содержит в себе клеммные соединители, рассчитанные для подключения и управления внешними исполнительными механизмами – двигателями постоянного тока. Расположение контактов в блоке приведено на Рисунке:

.. figure:: images/14.png
       :width: 40 %
       :align: center
       :alt: jsar


Плата расширения
~~~~~~~~~~~~~~~~

В состав набора помимо основного контроллера ESP-JS-AR входит плата расширения для подключения периферийных модулей. Цель этой платы – упростить процесс подключения различных внешних модулей к основному контроллеру за счет большого количество организованных стандартным образом выводов. 

.. figure:: images/15.png
       :width: 40 %
       :align: center
       :alt: jsar


Помимо классического расширения портов для подключения внешних устройств плата так же обладает реализацией Dynamixel-интерфейса как в 1-wire TTL исполнении, так и в RS485. 

Интерфейсы 
""""""""""

Для обеспечения удобства подключения на плате продублированы все популярные интерфейсы, а так же снабжены дополнительными линиями питания. Таким образом для подключения к интерфейсам I2C, SPI и UART больше не требуется разделенными проводами подключаться к разным местам платы. Так же на плату выведен интерфейс для подключения Dynamixel-совместимых устройств и данный интерфейс так же продублирован всеми популярными типами разъемов – Molex 3pin, Molex 4pin, Molex mini, JST 3pin, JST 4pin.

.. figure:: images/16.png
       :width: 40 %
       :align: center
       :alt: jsar


Здесь:

7.	``Блок 4х проводных разъемов интерфейса RS484``, используемого для подключения Dynamixel-совместимых устройств, использующих 4х пиновую схему подключения. 

8.	``Блок 3х проводных разъемов интерфейса 1-wire TTL``, используемого для подключения Dynamixel-совместимых устройств, использующих 3х пиновую схему подключения. 

9.	``Джампер DIR`` служит для выбора полярности пина, управляющего Dynamixel-линией. 

10.	``Джамперы``, замыкающие линии UART. При установленных джамперах линии UART расходятся по плате и реализуют Dynamixel-интерфейс. 

11.	``4х пиновый блок`` подключения к интерфейсу UART. Данный UART является замультиплексированным к основному UART платы, таким образом его можно использовать параллельно с Dynamixel-интерфейсом. 

12.	``Колодка для вывода программного UART``. TX – 8 цифровая линия, RX – 9 цифровая линия.

13.	``Колодка для подключения к SPI интерфейсу``

14.	``Проходной ISP интерфейс``. Содержит в себе SPI. Не является аналогом колодки в зависимости от типа основной платы SPI от основной платы будет выводиться либо на колодку 13, либо на колодку 14.

Прочий функционал
"""""""""""""""""

Помимо системы питания и наличия различных интерфейсов на плате расширения располагается еще ряд	функциональных блоков, изображенных на Рисунке:

.. figure:: images/17.png
       :width: 40 %
       :align: center
       :alt: jsar


Здесь:

15.	``Программируемый светодиод``, по умолчанию управляется цифровой линией 13.
16.	``Индикационный светодиод`` наличия питания 5В.
17.	``Индикационный светодиод`` линии RX интерфейса UART.
18.	``Индикационный светодиод`` линии TX интерфейса UART.
19.	``Блок цифровых линий``, совмещенных с питанием VCC. Может быть использован для удобного подключения 3х пиновых периферийных модулей, требующих силовое питания, например, сервоприводов. Не рекомендуется подключать сюда Arduino-совместимые датчики.
20.	``Блок цифровых линий``, совмещенных с питанием 5В. Может быть использован для подключения цифровых датчиков.
21.	``Блок линий 5В``. Может быть использован для взятия питания 5В (нижние 2 штыря – с основной платы, верхние 2 штыря – с платы расширения), либо для установки джамперов и передачи питания 5В с платы расширения на основную плату (см. схемы организации питания).


Электронные функциональные модули
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Блок содержит несколько модулей (датчиков, плат, ключей, кнопок, дисплеев, светодиодов) соединённых проводами и закреплённых на корпусе блока. 

Список модулей:
~~~~~~~~~~~~~~~

Светодиод
"""""""""

.. |pic1| image:: images/5.png
   :width: 45%

.. |pic2| image:: images/6.png
   :width: 32%

|pic1| |pic2|

Модуль “Светодиод” имеет:

``Разъём DXL`` - два трёхпиновых разъёма типа Molex, содержащих в себе линии GND (земля), VCC (питание), DATA (линия данных). Используются для подключения модуля по интерфейсу Dynamixel, как в одиночном виде, так и в составе цепи устройств.

``Разъём типа RJ14`` для подключения модуля в фирменную плату расширения для подключения сенсорных модулей.

``Шестипиновый разъём``, содержащий следующие линии:

``VCC``- линия питания, на которую можно подать напряжение в диапазоне от 5В до 12В;

``NC`` - неиспользуемая линия;

``5V`` - линия питания, на которую можно подать напряжение 3.3В или 5В. При подаче напряжения питание 3.3В необходимо следить, чтобы на линиях VCC отсутствовало напряжение;

``EN`` - сигнальная линия;

``NC`` - неиспользуемая линия;

``GND`` - линия земли;

``Светодиод`` - одноцветный источник излучения.

Датчик влажности
""""""""""""""""

Модуль ``Датчик влажности воздуха и температуры`` построен на базе сенсора DHT11, способного определять температуру и влажность окружающей среды в области около нормальных климатических условий (при температуре от 0 до 50 градусов и влажности от 20 до 90%).

.. figure:: images/8.png
       :width: 50%
       :align: center
       :alt: Датчик влажности воздуха и температуры


LED-дисплей
"""""""""""

``LED-дисплей`` (светодиодный дисплей) представляет собой вид дисплея, который использует светодиоды (Light-Emitting Diodes) в качестве источника света. Он состоит из множества светодиодов, сгруппированных в матрицу или сегменты.
В данном блоке используется ``четырёхсегментный LED-дисплей``.

.. figure:: images/10.png
       :width: 60%
       :align: center
       :alt: дисплей


Тактовые кнопки (5 штук) 
""""""""""""""""""""""""

Модуль ``Тактовая кнопка``, по своей сути, является обычной тактовой кнопкой, размещенной на плате с микроконтроллером, Данный модуль предполагается использовать для более удобного подключения кнопок к популярным микроконтроллерам.
Внешний вид представлен на изображении LED-дисплея под дисплеем.

.. figure:: images/11.png
       :scale: 100 %
       :align: center
       :alt: кнопка


Кроме того, в конструкции предусмотрены ``релейные модули`` и ``модули силового ключа`` (4 штуки) для управления напряжением на управляющей плате.

Позиционирование блока на Agrolab GH
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. figure:: images/12.png
       :width: 60%
       :align: center
       :alt: Позиционирование блока на Agrolab GH
